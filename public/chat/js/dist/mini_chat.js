function miniChatCallFileUpload(e){$("#miniChatfileToUpload"+e).trigger("click")}function uploadFilesToServerSendPost(e,i,a){var s=document.getElementById("miniChatfileToUpload"+i).files,t=new FormData;t.append("project","files");var n=!0;for(var o in s){var d=s[o].size/1024/1024;d>=25&&(n=!1),t.append("uploadedFile",s[o])}if(n){var r=new XMLHttpRequest;r.upload.addEventListener("progress",function(e){if(e.lengthComputable){var a=e.loaded/e.total;$(".miniChatonFileUploadProgress"+i).show(),$(".miniChatonFileUploadProgress"+i).html(""),$(".miniChatonFileUploadProgress"+i).css("width",100*a+"%")}else $(".miniChatonFileUploadProgress"+i).html("Uploading ... ")}.bind(this),!1),r.addEventListener("load",function(e){var s=JSON.parse(e.currentTarget.response),t=s.name.split("."),n="<a href='"+s.filepath+"'>"+s.name+"</a>";"png"!==t[t.length-1]&&"jpg"!==t[t.length-1]&&"gif"!==t[t.length-1]||(n="<img class='user_photos_class' src='"+s.filepath+"' alt='' />"),sendMessageWithText(i,a,"_",n),$(".miniChatonFileUploadProgress"+i).hide()}.bind(this),!1),r.open("POST","/messages_file_upload"),r.send(t)}else $(".miniChatonFileUploadProgress"+i).show(),$(".miniChatonFileUploadProgress"+i).html("Too big file. Max - 25MB.")}function startMiniChat(e,i){api.socketService=e,api.socketService.connectedUsers="",api.getCredData(function(e){if("error"!=e){listeningToShow(),miniChatListenSocket();var i=e.friends.filter(function(e){return e.show});listFriends(i),i.length>0&&miniChatClicked(i[0]._id)}},i)}function listFriends(e){for(var i="",a=0;a<e.length;a++)i+=0==a?'<div id="mini_chat'+e[a]._id+'" data-email="'+e[a].email+'" onclick="miniChatClicked(\''+e[a]._id+'\')" class="userChoose miniChatSelectedUser min_chat_choose_user">':'<div id="mini_chat'+e[a]._id+'" data-email="'+e[a].email+'" onclick="miniChatClicked(\''+e[a]._id+'\')" class="userChoose min_chat_choose_user">',""!=e[a].pic&&(i+='<div class="message_from_left_for_photo">',i+='<img class="message_from_left miniChatListPhoto" src="/files/'+e[a].pic+'" alt="">',i+="</div>"),i+='<div class="usersNameBv">',i+=e[a].firstname+" "+e[a].lastname,i+="</div>",i+='<div class="bottom"></div>',i+="</div>";$("#friendsView").html(i),$("#chatWindowView").html(addChatWindow())}function miniChatClicked(e){api.selectedUser=e,$(".miniChatSelectedUser").removeClass("miniChatSelectedUser"),$("#mini_chat"+e).addClass("miniChatSelectedUser");var i=api.getMessages(e);"error"!==i&&i.success(function(e){api.selectedUserMessage=e;var i="",a=e.messages;a.reverse();for(var s=0;s<a.length;s++)addToObjPicFriend(a[s]),i+=addChatMessage(a[s]);$("#minichatMessages").html(i),"undefined"!=typeof $("#minichatMessages")[0]&&$("#minichatMessages").scrollTop($("#minichatMessages")[0].scrollHeight)}).error(function(e,i){})}function addToObjPicFriend(e){for(var i=0;i<api.data.friends.length;i++)e.email===api.data.friends[i].from&&("undefined"!=typeof api.data.friends[i].pic&&""!=api.data.friends[i].pic&&(e.pic=api.data.friends[i].pic),e.firstname=api.data.friends[i].firstname,e.lastname=api.data.friends[i].lastname)}function addChatMessage(e){var i="";return e.from!=api.data.email?(i+='<div id="messagesContainerInnerHere">',i+='<div class="messages_from_them">',"undefined"!=typeof e.pic&&""!=e.pic&&(i+='<div class="message_from_left_for_photo">',i+='  <div class="message_from_left">',i+='   <img class="profileListPhoto" src="/files/'+e.pic+'" alt="">',i+="  </div>",i+="</div>"),i+='<div class="message_text_left">'+e.message,i+="<div>","undefined"!=typeof e.files&&""!=e.files&&(i+="<div>",i+=e.files,i+="</div>"),i+="</div>",i+='<div style="font-size:10px;">'+e.date+"</div>",i+="</div>",i+="</div>",i+="</div>"):(i+='<div id="messagesContainerInnerHere">',i+='<div class="messages_from_them myMessageInChat">',i+='<div class="message_text_left">'+e.message,i+="<div>","undefined"!=typeof e.files&&""!=e.files&&(i+="<div>",i+=e.files,i+="</div>"),i+="</div>",i+='<div style="font-size:10px;">'+e.date+"</div>",i+="</div>",i+="</div>",i+="</div>"),i}function getSelectedUsersEmailById(e){return $("#mini_chat"+e).attr("data-email")}function addChatWindow(){return addChatWindowParams("","")}function addChatWindowParams(e,i){var a='<div id="minichatMessages"></div>';return a+='<div class="miniChatonWrittingToUser">Writting ...</div>',a+='<div class="miniChatonFileUploadProgress'+e+'"></div>',a+='<div class="bottomsendmsg miniChatBottom" style="background:none!important;">',a+='<textarea onkeyup="onMiniChatWritting()" placeholder="Message ..." id="minichatTextareaa'+e+'" class="minichatTextarea"></textarea>',a+='<div class="miniChatLeftSendMsgs"><button onclick="miniChatSendMessage(\''+e+"','"+i+'\')" class="sendButton">Send</button>',a+="<button onclick=\"miniChatCallFileUpload('"+e+'\')" class="sendButton addFileButton glyphicon glyphicon-file icon-in-menu icon-turn-off"></button>',a+="<input onchange=\"uploadFilesToServerSendPost(this,'"+e+"','"+i+'\')" type="file" id="miniChatfileToUpload'+e+'" style="display:none;">',a+="</div></div>"}function miniChatSendMessage(e,i){var a=$("#minichatTextareaa"+e).val();$("#minichatTextareaa"+e).val(""),sendMessageWithText(e,i,a,"")}function sendMessageWithText(e,i,a,s){if(""!=i){var t=api.getMessages(i);"error"!==t&&t.success(function(t){sendMsg(a,t._id,i,s),$("#miniChatObject"+e).html(""),setShowNotifHeightButton()})}else sendMsg(a,api.selectedUserMessage._id,api.selectedUser,s)}function sendMsg(e,i,a,s){if(""!=e){var t={from:api.data.email,message:e,files:s};api.sendMessage({id:i,message:t});if(""!=a){var n=getSelectedUsersEmailById(a);sendThroughSocket(api.data._id,api.data.email,api.data.email,t.message,s),sendThroughSocket(api.data._id,api.data.email,n,t.message,s)}}}function sendThroughSocket(e,i,a,s,t){api.socketService.emit("chat message",{from_id:e,from:i,to:"",toEmail:a,msg:s,message:s,files:t})}function onMiniChatWritting(){var e=getSelectedUsersEmailById(api.selectedUser);api.socketService.emit("message_writting",{from:api.data.email,toEmail:e})}function miniChatListenSocket(){api.socketService.on("message_writting",function(e){var i=getSelectedUsersEmailById(api.selectedUser);e.from===i&&($(".miniChatonWrittingToUser").show(),this.onMiniWrittingToUserTimeStamp=Date.now(),setTimeout(function(){Date.now()-this.onMiniWrittingToUserTimeStamp>1990&&$(".miniChatonWrittingToUser").hide()}.bind(this),2e3))}),api.socketService.on("user_connected",function(e){api.socketService.connectedUsers=e.users}),api.socketService.on("user_disconnected",function(e){api.socketService.connectedUsers=e.users}),api.socketService.on("chat message",function(e){if(e.from_id===api.selectedUser||e.from_id===api.data._id){e.date=nowTime(),e.message=e.msg;var i=addChatMessage(e);$("#minichatMessages").append(i),$("#minichatMessages").scrollTop($("#minichatMessages")[0].scrollHeight)}if(!$("#notificationsView").is(":visible")&&e.from!==api.data.email){e.date=nowTime(),e.message=e.msg,addToObjPicFriend(e);var i=addChatMessage(e),a=e.date.replace(/ /g,"_").replace(":","")+Math.floor(1e3*Math.random()+1),s=addChatWindowParams(a,e.from_id),t='<div class="miniChatBackMessage">'+s+"</div>";i='<div id="miniChatObject'+a+'" style="clear:both;"><div class="miniChatMiniNotName">'+e.firstname+" "+e.lastname+"</div>"+i+t+"</div>";var n=getNotificationMiniHtml();showNotificationMini(n+i)}})}function nowTime(){var e=new Date,i=e.getDate(),a=e.getMonth()+1,s=e.getHours(),t=e.getMinutes(),n=e.getFullYear();i<10&&(i="0"+i),a<10&&(a="0"+a);var e=n+" "+a+" "+i+" "+s+":"+t;return e}